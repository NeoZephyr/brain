## 用户态

内存映射不仅仅是物理内存和虚拟内存之间的映射，还包括将文件中的内容映射到虚拟内存空间。这个时候，访问内存空间就能够访问到文件里面的数据

![[Pasted image 20230202084219.png]]
### mmap

如果要申请小块内存，就用 brk 函数。如果申请一大块内存，就要用 mmap。对于堆的申请来讲，mmap 是映射内存空间到物理内存。另外，如果一个进程想映射一个文件到自己的虚拟内存空间，也要通过 mmap 系统调用。这个时候 mmap 是映射内存空间到物理内存再到文件

### 缺页异常

一旦开始访问虚拟内存的某个地址，如果没有对应的物理页，那就触发缺页中断。用户态缺页异常处理完毕后，物理内存中有了页面，页表也建立好了映射。接下来，用户程序在虚拟内存空间里面，可以通过虚拟地址顺利经过页表映射的访问物理页面上的数据了

### TLB

页表一般都很大，只能存放在内存中。操作系统每次访问内存都要先通过查询页表得到物理地址，然后访问该物理地址读取指令、数据。为了提高映射速度，引入了 TLB（Translation Lookaside Buffer），通常称为快表，专门用来做地址映射的硬件设备。它不在内存中，可存储的数据比较少，但是比内存要快。所以，可以认为 TLB 就是页表的 Cache，其中存储了当前最可能被访问到的页表项，其内容是部分页表项的一个副本

有了 TLB 之后，访问内存时，可以先查块表，块表中有映射关系，然后直接转换为物理地址。如果在 TLB 查不到映射关系时，才会到内存中查询页表

![[Pasted image 20230202085559.png]]
