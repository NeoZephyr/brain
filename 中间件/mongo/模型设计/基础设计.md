![[Pasted image 20230305115445.png]]

## 基础建模

### 一对一

一对一关系以内嵌为主。要避免内嵌后可能导致文档大小超过 16MB

![[Pasted image 20230305115512.png]]

### 一对多

一对多关系同样以内嵌为主。用数组来表示一对多，要避免内嵌后导致文档大小超过 16MB，以及数组长度太大

![[Pasted image 20230305115535.png]]

### 多对多

一般用内嵌数组来表示一对多，通过冗余来实现多对多。要避免内嵌后导致文档大小超过 16MB，数组长度太大

![[Pasted image 20230305115556.png]]

## 工况细化

![[Pasted image 20230305115612.png]]

有千万级联系人，一个分组可以有百万级联系人。需要频繁变动分组的信息，如增加分组及修改名称及描述以及营销状态。那么，一个分组信息的改动意味着百万级的 DB 操作

![[Pasted image 20230305115632.png]]

Group 使用单独的集合，用 id 或者唯一键关联，使用 $lookup 来提供一次查询多表的能力（$lookup 的关联目标表 Groups 不能是分片表）

```bash
db.contacts.aggregate([
	{
  	$lookup: {
      from: "groups",
      localField: "group_ids",
      foreignField: "group_id",
      as: "groups"
    }
  }
])
```

![[Pasted image 20230305115721.png]]

![[Pasted image 20230305115733.png]]

头像使用高保真，大小在 5MB - 10MB，头像一旦上传，一个月不可更换，基础信息查询（不含头像）和头像查询的比例为 9:1。建议使用引用方式，把头像数据放到另外一个集合，可以显著提升 90% 的查询效率